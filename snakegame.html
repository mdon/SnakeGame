<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<style>
body {
   overflow:hidden;
   padding: 0px;
   margin: 0px;
}
</style>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script>
"use strict";
var pixelRatio = 1;
var mouseX = 0;
var mouseY = 0;
var canvas = "";
var ctx = "";
var horizontalCount = 10;
var verticalCount = 10;
var blockWidth = 30;
var blockHeight = 30;
var food = [];
var initialFoodCount = 10;
var snake = [];
var snakeLength = 1; 
var snakeX = 0;
var snakeY = 0;
var snakeDirection = 0;
var state = 0; // 0 - main menu; 1 - plaing; 2 - game over
var borderSpacing = 23;

var cherry = new Image();
cherry.src = 'cherry.png';

function init() {
   canvas = document.getElementById("c1");
   ctx = canvas.getContext("2d");

   var backingStoreRatio = ctx.webkitBackingStorePixelRatio ||
                           ctx.mozBackingStorePixelRatio ||
                           ctx.msBackingStorePixelRatio ||
                           ctx.oBackingStorePixelRatio ||
                           ctx.backingStorePixelRatio;

   pixelRatio = window.devicePixelRatio || 1;

   canvas.addEventListener('mousemove', function (e) {
      mouseX = e.pageX - canvas.offsetLeft;
      mouseY = e.pageY - canvas.offsetTop;
   }, 0);

   ctx.font = "11pt Calibri";
   ctx.strokeStyle = "red";

   canvas.addEventListener('mousedown', function(e) {
      var mouseX = e.pageX - canvas.offsetLeft;
      var mouseY = e.pageY - canvas.offsetTop;

      if (state == 0) {
         // we are in a main menu
         if (mouseX > 280 && mouseY > 240 && mouseX < 452 && mouseY < 310) {
            newGame(); 
            state = 1;
            console.log('mouseX - ' + mouseX + ' mouseY - ' + mouseY);
         }
      } else if (state == 1) {
         // we are in the game
      } else if (state == 2) {
         // we are in the game over screen
         snakeDirection = 0;
         snakeLength = 1;
         state = 0;
         newGame();
      }
   }, 0);

   window.addEventListener('keydown', function (e) {
      var toY, toX;

      if(state == 1) {
         if (e.keyCode == 38) {         // up
            if (snakeDirection != 2 && snakeDirection != 4) {
               snakeDirection = 4;
               toY = snakeY - 1;
               toX = snakeX;
               moveThere(toY, toX);
            }
         } else if (e.keyCode == 40) {  // down
            if (snakeDirection != 4 && snakeDirection != 2) {
               snakeDirection = 2;
               toY = snakeY + 1;
               toX = snakeX;
               moveThere(toY, toX);
            }
         } else if (e.keyCode == 37) {  // left
            if (snakeDirection != 3 && snakeDirection != 1) {
               snakeDirection = 1;
               toY = snakeY;
               toX = snakeX - 1;
               moveThere(toY, toX);
            }
         } else if (e.keyCode == 39) {  // right
            if (snakeDirection != 1 && snakeDirection != 3) {
               snakeDirection = 3;
               toY = snakeY;
               toX = snakeX + 1;
               moveThere(toY, toX);
            }
         }
      }
   },true);

   recalculate();
   setInterval(draw, 10);
   setInterval(auto_move, 500);
}

function moveThere(toY, toX) {
   //console.log('this part works');
   if (canSnakeMoveThere(snakeY, snakeX, toY, toX)) {

      // eating tail so that it turns in to apples 
      if(snake[toY][toX] > 0) {
         var cellThatWeAreStepingOn = snake[toY][toX];

         console.log('stepping on ' + cellThatWeAreStepingOn  + ' tail cell');
         for(var y = 0; y < verticalCount; y++) {
            for(var x = 0; x < horizontalCount; x++) {
               if(snake[y][x] > cellThatWeAreStepingOn){
                  snake[y][x] = 0;
                  food[y][x] = 1;
               }
            }
         }

         // making the snakeLenght variable to the correct number
         snakeLength = cellThatWeAreStepingOn-1;
      }

      // moving the head to the next block
      snake[toY][toX] = 1;

      if(snakeLength == 1) {
         // cheking if where we are steping has food. if yes, we are making snake longer
         // and if not, we just swithing off where we used to be.
         if (food[toY][toX] != 1) {
            snake[snakeY][snakeX] = 0;
         } else {
            snake[snakeY][snakeX] = 2;
            //snakeLength = 2;
         }
      } else {
         // looking for the tail
         var largest = 0;
         var largestY = -1;
         var largestX = -1;

         for (var y=0; y<verticalCount; y++) {
            for (var x=0; x<horizontalCount; x++) {
               if(snake[y][x] > largest) {
                  largest = snake[y][x];
                  largestY = y;
                  largestX = x;
                  //console.log('found tail at y:' + y + '| x:' + x + '| largest:' + largest);
               }
            }
         }

         // turning the tail off
         if (food[toY][toX] != 1) {
            snake[largestY][largestX] = 0;
         } else {
            snake[largestY][largestX] = snakeLength;
         }

         // re-numbering the snake, every thing exept the head
         for (var y=0; y<verticalCount; y++) {
            for (var x=0; x<horizontalCount; x++) {
               if(snake[y][x] > 0) {
                  if (y == toY && x == toX) {
                     //console.log('this is head, we are skipping');
                  } else {
                     snake[y][x]++;
                     //console.log('re-numbering at y:' + y + '| x:' + x);
                  }
               }
            }
         }
      }

      snakeY = toY;
      snakeX = toX;

      // cheking if we are eating the cherry, if yes, then generate a new spot for the cherry,
      if(food[snakeY][snakeX] == 1) {
         food[snakeY][snakeX] = 0;

         // putting new cherry on the field when eaten
         var foodPlaced = 0;
         for(var x=0; x<10 && foodPlaced == 0; x++) {
            var cordY = Math.floor(Math.random() * verticalCount);
            var cordX = Math.floor(Math.random() * horizontalCount);

            if(snake[cordY][cordX] && snake[cordY][cordX] > 0) {
               console.log("can't place food at cordY: " + cordY + "| cordX: " + cordX + " will try again");
            } else {
               food[cordY][cordX] = 1;
               foodPlaced = 1;
            }
         }
         snakeLength++;
      }
   }
}

function canSnakeMoveThere(fromY, fromX, toY, toX) {
   //console.log('toY:' + toY + ' toX:' + toX + ' fromY:' + fromY + ' fromX:' + fromX);
   if(toX > horizontalCount-1 || toX < 0 || toY < 0 || toY > verticalCount-1) {
      state = 2;
      return false;
   } else {
      return true;
   }

}


function auto_move() {
   if(snakeDirection == 4) {
      // moving up
      moveThere(snakeY-1, snakeX);
   } else if(snakeDirection == 3) {
      // moving right
      moveThere(snakeY, snakeX+1);
   } else if(snakeDirection == 2) {
      // moving down
      moveThere(snakeY+1, snakeX);
   } else if(snakeDirection == 1) {
      // moving left
      moveThere(snakeY, snakeX-1);
   } else if(snakeDirection == 0) {
   }
}

function recalculate() {
   canvas.style.width  = document.body.clientWidth;
   canvas.style.height = document.body.clientHeight;
   canvas.width        = document.body.clientWidth;
   canvas.height       = document.body.clientHeight;

   if (pixelRatio > 1) {
      canvas.setAttribute('width', canvas.width * pixelRatio);
      canvas.setAttribute('height', canvas.height * pixelRatio);
      context.scale(pixelRatio, pixelRatio);
   }

   horizontalCount = Math.floor((canvas.width - (borderSpacing*2)) / blockWidth);
   verticalCount = Math.floor((canvas.height - (borderSpacing*2)) / blockHeight);
}

function draw() {
   canvas.width=canvas.width;

   if (state == 0) {
      // draw main menu
      ctx.font = "70pt Calibri";
      ctx.strokeStyle = "red";
      ctx.fillText('Pocket Snake',100,200);
      ctx.font = "60pt Calibri";
      ctx.fillText('Start',290,300);
      ctx.strokeRect(280,240,170,70);
   } else if (state == 1) {
      // playing
      ctx.fillStyle = "red";
      ctx.rect(borderSpacing,borderSpacing,80,80);

      ctx.fillStyle = "#2cba30";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "#79d87b";
      ctx.fillRect(borderSpacing, borderSpacing, canvas.width-borderSpacing*2, canvas.height-borderSpacing*2);

      for (var y=0; y<verticalCount; y++) {
         for (var x=0; x<horizontalCount; x++) {
            // calculate block coordinates
            var rectX = Math.ceil(x*blockWidth)+0.5;
            var rectY = Math.ceil(y*blockHeight)+0.5;

            ctx.beginPath();
            ctx.fillStyle = "white";
            ctx.rect(rectX+borderSpacing, rectY+borderSpacing, blockWidth, blockHeight);
//            var color = "black";
//            ctx.strokeStyle = color;
//            ctx.fillStyle = color;
//            ctx.closePath();

            //if(mouseX > x*blockWidth && mouseX < x*blockWidth+blockWidth && mouseY > y*blockHeight && mouseY < y*blockHeight+blockHeight) {
            if(snake[y][x]) {
               ctx.strokeStyle = "white"; 
               ctx.fill();
            } else {
               ctx.strokeStyle = "#79d87b"; 
            }

            ctx.stroke();

            //if(snake[y][x]>-1) ctx.strokeText(snake[y][x], rectX+blockWidth/2, rectY+blockHeight/2);
         }
      }

      for (var y=0; y<verticalCount; y++) {
         for (var x=0; x<horizontalCount; x++) {
            if(food[y][x]) {
               ctx.drawImage(cherry,Math.ceil(x*blockWidth)+3+borderSpacing, Math.ceil(y*blockHeight)+3+borderSpacing);
            }
         }
      }
      ctx.fillStyle = "red";
      ctx.font = "15pt Calibri";
      ctx.fillText('length: ' + snakeLength, 10, canvas.height-5);

      ctx.fillStyle = "red";
      ctx.rect(borderSpacing,borderSpacing,80,80);
   } else if (state == 2) {
      // game over
      ctx.font = "70pt Calibri";
      ctx.strokeStyle = "red";
      ctx.fillText('The End',100,200);
      ctx.font = "40pt Calibri";
      ctx.fillText('Your Length was: ' + snakeLength,100,250);
      ctx.font = "20pt Calibri";
      ctx.fillText('click any where to get back to main menu',100,300);
   } else { 
      // strange, unknown state
      console.log('strange, unknown state, the state is:' + state);
   }
}

function newGame() {
   // filling the field with random food
   for (var y=0; y<verticalCount; y++) {
      food[y] = new Array(horizontalCount);
   }

   for (var i=0;i<initialFoodCount; i++) {
      food[Math.floor(Math.random() * verticalCount)][Math.floor(Math.random() * horizontalCount)] = 1;
   }

   // init snake
   for (var y=0; y<verticalCount; y++) {
      snake[y] = new Array(horizontalCount);
   }

   snakeX = Math.floor(Math.random() * horizontalCount);
   snakeY = Math.floor(Math.random() * verticalCount);   

   snake[snakeY][snakeX] = 1;

}

</script>
</head>

<body onload="init()">
<canvas id="c1" width=600 height=600></canvas>
</body>
